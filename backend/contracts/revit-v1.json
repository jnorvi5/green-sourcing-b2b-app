{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "GreenChainz Revit Integration API Contract",
  "version": "1.1.0",
  "description": "API contract for Revit add-in integration with GreenChainz sustainability platform",
  "contact": {
    "name": "GreenChainz API Support",
    "url": "https://greenchainz.com/support",
    "email": "api@greenchainz.com"
  },
  "authentication": {
    "type": "Azure Entra ID",
    "flow": "OAuth 2.0 Authorization Code with PKCE",
    "scopes": ["openid", "profile", "email"],
    "endpoints": {
      "authorize": "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize",
      "token": "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"
    },
    "headers": {
      "Authorization": "Bearer {access_token}",
      "X-Plugin-Instance-ID": "{unique_plugin_installation_id}",
      "X-Revit-Version": "{revit_version}",
      "X-Plugin-Version": "{plugin_version}",
      "X-Session-Token": "{session_token_when_in_session}"
    }
  },
  "baseUrl": "https://api.greenchainz.com/api/integrations/revit/v1",
  "endpoints": {
    "info": {
      "method": "GET",
      "path": "/",
      "auth": "none",
      "description": "API information and health check",
      "response": {
        "type": "object",
        "properties": {
          "api": { "type": "string" },
          "version": { "type": "string" },
          "status": { "type": "string", "enum": ["operational", "degraded", "maintenance"] }
        }
      }
    },
    "register": {
      "method": "POST",
      "path": "/register",
      "auth": "azure_entra",
      "description": "Register a Revit plugin instance",
      "request": {
        "type": "object",
        "required": ["pluginInstanceId"],
        "properties": {
          "pluginInstanceId": {
            "type": "string",
            "description": "Unique identifier generated by plugin on installation (UUID recommended)",
            "format": "uuid"
          },
          "revitVersion": {
            "type": "string",
            "description": "Revit version (e.g., '2024', '2025')",
            "pattern": "^20[2-9][0-9]$"
          },
          "pluginVersion": {
            "type": "string",
            "description": "Plugin version (semver)",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "machineName": {
            "type": "string",
            "description": "Computer name for audit purposes"
          }
        }
      },
      "response": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean" },
          "registrationId": { "type": "integer" },
          "status": { "type": "string", "enum": ["created", "updated"] },
          "message": { "type": "string" }
        }
      }
    },
    "sessions": {
      "start": {
        "method": "POST",
        "path": "/sessions",
        "auth": "azure_entra + plugin_registered",
        "description": "Start a new sync session",
        "request": {
          "type": "object",
          "properties": {
            "projectFileHash": {
              "type": "string",
              "description": "SHA256 hash of the Revit file for project identification",
              "pattern": "^[a-f0-9]{64}$"
            },
            "projectName": {
              "type": "string",
              "description": "Revit project name"
            },
            "projectPath": {
              "type": "string",
              "description": "Local file path of the Revit project"
            }
          }
        },
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "session": {
              "type": "object",
              "properties": {
                "id": { "type": "integer" },
                "token": { "type": "string", "description": "Session token for subsequent requests" },
                "startedAt": { "type": "string", "format": "date-time" }
              }
            }
          }
        }
      },
      "end": {
        "method": "DELETE",
        "path": "/sessions/{sessionToken}",
        "auth": "azure_entra + plugin_registered",
        "description": "End a sync session"
      },
      "heartbeat": {
        "method": "POST",
        "path": "/sessions/{sessionToken}/heartbeat",
        "auth": "azure_entra + plugin_registered",
        "description": "Keep session alive (call every 5-10 minutes)"
      }
    },
    "projects": {
      "list": {
        "method": "GET",
        "path": "/projects",
        "auth": "azure_entra + plugin_registered",
        "description": "List user's synced Revit projects",
        "queryParams": {
          "limit": { "type": "integer", "default": 50, "max": 100 },
          "offset": { "type": "integer", "default": 0 },
          "status": { "type": "string", "enum": ["pending", "syncing", "synced", "error"] }
        },
        "response": {
          "type": "object",
          "properties": {
            "projects": {
              "type": "array",
              "items": { "$ref": "#/definitions/Project" }
            },
            "pagination": { "$ref": "#/definitions/Pagination" }
          }
        }
      },
      "create": {
        "method": "POST",
        "path": "/projects",
        "auth": "azure_entra + plugin_registered + active_session",
        "description": "Create or update a project from Revit",
        "request": {
          "type": "object",
          "required": ["projectFileHash", "projectName"],
          "properties": {
            "projectFileHash": { "type": "string" },
            "projectName": { "type": "string" },
            "projectNumber": { "type": "string" },
            "clientName": { "type": "string" },
            "location": { "type": "string" },
            "buildingType": { "type": "string", "enum": ["Commercial", "Residential", "Industrial", "Institutional", "Mixed-Use", "Other"] },
            "grossArea": { "type": "number" },
            "areaUnit": { "type": "string", "enum": ["sqft", "sqm"], "default": "sqft" },
            "targetCertification": { "type": "string" }
          }
        }
      },
      "score": {
        "method": "GET",
        "path": "/projects/{projectId}/score",
        "auth": "azure_entra + plugin_registered",
        "description": "Get sustainability score for a project",
        "response": {
          "type": "object",
          "properties": {
            "projectId": { "type": "integer" },
            "projectName": { "type": "string" },
            "score": {
              "type": "object",
              "properties": {
                "overall": { "type": "integer", "minimum": 0, "maximum": 100 },
                "leedPointsTotal": { "type": "number" },
                "totalEmbodiedCarbonKg": { "type": "number" },
                "carbonPerSqft": { "type": "number" }
              }
            },
            "coverage": {
              "type": "object",
              "properties": {
                "totalMaterials": { "type": "integer" },
                "mappedMaterials": { "type": "integer" },
                "verifiedMaterials": { "type": "integer" },
                "mappingPercentage": { "type": "integer" },
                "fscPercentage": { "type": "integer" },
                "epdPercentage": { "type": "integer" }
              }
            },
            "recommendations": {
              "type": "array",
              "items": { "$ref": "#/definitions/Recommendation" }
            }
          }
        }
      }
    },
    "materials": {
      "list": {
        "method": "GET",
        "path": "/projects/{projectId}/materials",
        "auth": "azure_entra + plugin_registered",
        "description": "Get materials for a project"
      },
      "sync": {
        "method": "POST",
        "path": "/projects/{projectId}/materials/sync",
        "auth": "azure_entra + plugin_registered + active_session",
        "description": "Sync materials from Revit to GreenChainz",
        "rateLimit": { "requests": 10, "window": "1 minute" },
        "request": {
          "type": "object",
          "required": ["materials"],
          "properties": {
            "materials": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["revitMaterialId", "name"],
                "properties": {
                  "revitMaterialId": { "type": "string", "description": "Revit's internal material Element ID" },
                  "name": { "type": "string" },
                  "category": { "type": "string" },
                  "totalArea": { "type": "number", "description": "Total area in project units" },
                  "totalVolume": { "type": "number", "description": "Total volume in project units" },
                  "totalCount": { "type": "integer", "description": "Instance count" },
                  "quantityUnit": { "type": "string" }
                }
              }
            }
          }
        },
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "results": {
              "type": "object",
              "properties": {
                "created": { "type": "integer" },
                "updated": { "type": "integer" },
                "failed": { "type": "integer" },
                "errors": { "type": "array" }
              }
            }
          }
        }
      },
      "map": {
        "method": "POST",
        "path": "/materials/{mappingId}/map",
        "auth": "azure_entra + plugin_registered",
        "description": "Map a Revit material to a GreenChainz product",
        "request": {
          "type": "object",
          "properties": {
            "productId": { "type": "integer", "description": "GreenChainz product ID" },
            "categoryId": { "type": "integer", "description": "GreenChainz category ID" }
          }
        }
      },
      "alternatives": {
        "method": "POST",
        "path": "/materials/{mappingId}/alternatives",
        "auth": "azure_entra + plugin_registered",
        "description": "Get AI-powered sustainable alternatives for a mapped material",
        "request": {
          "type": "object",
          "properties": {
            "maxAlternatives": { 
              "type": "integer", 
              "default": 5, 
              "maximum": 5,
              "description": "Maximum number of alternatives to return" 
            },
            "prioritize": { 
              "type": "string", 
              "enum": ["sustainability", "carbon", "cost", "availability"],
              "default": "sustainability",
              "description": "What to prioritize when finding alternatives"
            }
          }
        },
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "mappingId": { "type": "integer" },
            "alternatives": {
              "type": "array",
              "items": { "$ref": "#/definitions/Alternative" }
            },
            "comparison": {
              "type": "object",
              "properties": {
                "currentMaterial": { "$ref": "#/definitions/MaterialSummary" },
                "bestAlternative": { "$ref": "#/definitions/Alternative" },
                "totalAlternatives": { "type": "integer" },
                "aiPowered": { "type": "boolean" }
              }
            },
            "aiStatus": { 
              "type": ["string", "object"],
              "description": "AI service status - 'ok' or error details with fallback info"
            }
          }
        }
      },
      "batchMatch": {
        "method": "POST",
        "path": "/materials/batch-match",
        "auth": "azure_entra + plugin_registered",
        "description": "Batch match Revit material names to catalog products with confidence scores",
        "request": {
          "type": "object",
          "required": ["materials"],
          "properties": {
            "materials": {
              "type": "array",
              "maxItems": 100,
              "items": {
                "oneOf": [
                  { "type": "string", "description": "Material name" },
                  {
                    "type": "object",
                    "required": ["name"],
                    "properties": {
                      "name": { "type": "string" },
                      "category": { "type": "string" },
                      "revitMaterialId": { "type": "string" }
                    }
                  }
                ]
              }
            }
          }
        },
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "matches": {
              "type": "array",
              "items": { "$ref": "#/definitions/BatchMatchResult" }
            },
            "stats": {
              "type": "object",
              "properties": {
                "total": { "type": "integer" },
                "matched": { "type": "integer" },
                "highConfidence": { "type": "integer" },
                "lowConfidence": { "type": "integer" },
                "noMatch": { "type": "integer" }
              }
            },
            "summary": {
              "type": "object",
              "properties": {
                "matchRate": { "type": "string", "description": "e.g., '75%'" },
                "highConfidenceRate": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "catalog": {
      "search": {
        "method": "GET",
        "path": "/catalog/search",
        "auth": "azure_entra + plugin_registered",
        "description": "Search GreenChainz catalog with sustainability scores (optimized for Revit)",
        "queryParams": {
          "q": { "type": "string", "description": "Search query" },
          "category": { "type": "string", "description": "Filter by category name or ID" },
          "certifications": { "type": "string", "description": "Comma-separated certification names" },
          "minScore": { "type": "integer", "minimum": 0, "maximum": 100, "description": "Minimum sustainability score" },
          "limit": { "type": "integer", "default": 20, "maximum": 50 },
          "offset": { "type": "integer", "default": 0 },
          "sortBy": { "type": "string", "enum": ["relevance", "score", "price_asc", "price_desc", "newest", "name"], "default": "score" }
        },
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "materials": {
              "type": "array",
              "items": { "$ref": "#/definitions/CatalogMaterial" }
            },
            "total": { "type": "integer" },
            "pagination": { "$ref": "#/definitions/Pagination" },
            "query": { "type": "string", "nullable": true }
          }
        }
      },
      "get": {
        "method": "GET",
        "path": "/catalog/{materialId}",
        "auth": "azure_entra + plugin_registered",
        "description": "Get material details by ID (lightweight for Revit)",
        "response": {
          "type": "object",
          "properties": {
            "success": { "type": "boolean" },
            "material": { "$ref": "#/definitions/CatalogMaterialDetail" }
          }
        }
      }
    },
    "products": {
      "search": {
        "method": "GET",
        "path": "/products/search",
        "auth": "azure_entra + plugin_registered",
        "description": "Search GreenChainz products for material matching",
        "queryParams": {
          "q": { "type": "string", "minLength": 2, "description": "Search query" },
          "category": { "type": "string" },
          "limit": { "type": "integer", "default": 20, "max": 50 }
        }
      },
      "match": {
        "method": "POST",
        "path": "/products/match",
        "auth": "azure_entra + plugin_registered",
        "description": "Auto-match Revit materials to GreenChainz products",
        "request": {
          "type": "object",
          "required": ["materialNames"],
          "properties": {
            "materialNames": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    },
    "rfq": {
      "create": {
        "method": "POST",
        "path": "/rfq",
        "auth": "azure_entra + plugin_registered",
        "description": "Create RFQ from Revit project materials",
        "request": {
          "type": "object",
          "required": ["projectId", "materialMappingIds"],
          "properties": {
            "projectId": { "type": "integer" },
            "materialMappingIds": {
              "type": "array",
              "items": { "type": "integer" }
            },
            "message": { "type": "string" },
            "deadline": { "type": "string", "format": "date" }
          }
        }
      }
    }
  },
  "definitions": {
    "Project": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "fileHash": { "type": "string" },
        "name": { "type": "string" },
        "number": { "type": "string" },
        "client": { "type": "string" },
        "location": { "type": "string" },
        "buildingType": { "type": "string" },
        "grossArea": { "type": "number" },
        "areaUnit": { "type": "string" },
        "targetCertification": { "type": "string" },
        "sustainabilityScore": { "type": "integer" },
        "syncStatus": { "type": "string" },
        "lastSyncedAt": { "type": "string", "format": "date-time" },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      }
    },
    "Material": {
      "type": "object",
      "properties": {
        "id": { "type": "integer" },
        "revitMaterialId": { "type": "string" },
        "name": { "type": "string" },
        "category": { "type": "string" },
        "mappedProduct": {
          "type": "object",
          "nullable": true,
          "properties": {
            "id": { "type": "integer" },
            "name": { "type": "string" }
          }
        },
        "sustainability": {
          "type": "object",
          "properties": {
            "embodiedCarbonKgCO2e": { "type": "number", "nullable": true },
            "epdNumber": { "type": "string", "nullable": true },
            "fscCertified": { "type": "boolean" },
            "leedPoints": { "type": "number", "nullable": true }
          }
        },
        "quantity": {
          "type": "object",
          "properties": {
            "area": { "type": "number", "nullable": true },
            "volume": { "type": "number", "nullable": true },
            "count": { "type": "integer", "nullable": true },
            "unit": { "type": "string" }
          }
        },
        "status": { "type": "string", "enum": ["unmapped", "auto_mapped", "manual_mapped", "verified", "rejected"] },
        "confidence": { "type": "number", "nullable": true }
      }
    },
    "Recommendation": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "enum": ["sync", "mapping", "fsc", "epd", "leed"] },
        "priority": { "type": "string", "enum": ["high", "medium", "low"] },
        "message": { "type": "string" }
      }
    },
    "Pagination": {
      "type": "object",
      "properties": {
        "total": { "type": "integer" },
        "limit": { "type": "integer" },
        "offset": { "type": "integer" },
        "hasMore": { "type": "boolean" },
        "page": { "type": "integer" },
        "totalPages": { "type": "integer" }
      }
    },
    "Alternative": {
      "type": "object",
      "properties": {
        "rank": { "type": "integer" },
        "id": { "type": "integer", "nullable": true, "description": "Product ID if from catalog" },
        "name": { "type": "string" },
        "category": { "type": "string", "nullable": true },
        "supplier": { "type": "string", "nullable": true },
        "sustainabilityScore": { "type": "integer", "nullable": true },
        "scoreImprovement": { "type": "string", "nullable": true, "description": "e.g., '+15.5%'" },
        "estimatedCarbonReduction": { "type": "string", "nullable": true },
        "certifications": { "type": "array", "items": { "type": "string" } },
        "reason": { "type": "string", "nullable": true },
        "source": { "type": "string", "enum": ["ai", "catalog"] }
      }
    },
    "MaterialSummary": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "mappedProduct": { "type": "string", "nullable": true },
        "sustainabilityScore": { "type": "integer", "nullable": true },
        "embodiedCarbonKg": { "type": "number", "nullable": true },
        "fscCertified": { "type": "boolean" },
        "hasEPD": { "type": "boolean" }
      }
    },
    "BatchMatchResult": {
      "type": "object",
      "properties": {
        "input": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "revitMaterialId": { "type": "string", "nullable": true }
          }
        },
        "matched": { "type": "boolean" },
        "bestMatch": { "$ref": "#/definitions/MatchSuggestion" },
        "suggestions": {
          "type": "array",
          "items": { "$ref": "#/definitions/MatchSuggestion" }
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "confidenceLevel": { "type": "string", "enum": ["high", "medium", "low"] },
        "error": { "type": "string", "nullable": true }
      }
    },
    "MatchSuggestion": {
      "type": "object",
      "properties": {
        "rank": { "type": "integer" },
        "productId": { "type": "integer" },
        "productName": { "type": "string" },
        "category": { "type": "string", "nullable": true },
        "supplier": { "type": "string", "nullable": true },
        "sustainabilityScore": { "type": "integer" },
        "tier": { "type": "string", "nullable": true },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "confidenceLevel": { "type": "string", "enum": ["high", "medium", "low"] }
      }
    },
    "CatalogMaterial": {
      "type": "object",
      "description": "Lightweight catalog material for Revit plugin",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "sku": { "type": "string", "nullable": true },
        "category": { "type": "string", "nullable": true },
        "supplier": { "type": "string", "nullable": true },
        "sustainabilityScore": { "type": "integer" },
        "certifications": { "type": "array", "items": { "type": "string" } },
        "certificationCount": { "type": "integer" },
        "unitPrice": { "type": "number", "nullable": true },
        "currency": { "type": "string", "nullable": true },
        "tier": { "type": "string", "enum": ["excellent", "good", "average", "unscored"] }
      }
    },
    "CatalogMaterialDetail": {
      "type": "object",
      "description": "Detailed catalog material for Revit plugin",
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "string" },
        "description": { "type": "string", "nullable": true },
        "sku": { "type": "string", "nullable": true },
        "category": {
          "type": "object",
          "properties": {
            "id": { "type": "integer" },
            "name": { "type": "string" }
          }
        },
        "supplier": {
          "type": "object",
          "properties": {
            "id": { "type": "integer" },
            "name": { "type": "string" }
          }
        },
        "sustainability": {
          "type": "object",
          "properties": {
            "score": { "type": "integer" },
            "tier": { "type": "string", "nullable": true },
            "whyRecommended": { "type": "string", "nullable": true }
          }
        },
        "certifications": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "certifyingBody": { "type": "string", "nullable": true },
              "status": { "type": "string" }
            }
          }
        },
        "epd": {
          "type": "object",
          "nullable": true,
          "properties": {
            "epdNumber": { "type": "string" },
            "globalWarmingPotential": { "type": "number", "nullable": true },
            "declaredUnit": { "type": "string", "nullable": true }
          }
        },
        "leedCredits": { "type": "integer" },
        "unitPrice": { "type": "number", "nullable": true },
        "currency": { "type": "string", "nullable": true }
      }
    },
    "Error": {
      "type": "object",
      "properties": {
        "error": { "type": "string", "description": "Error code" },
        "message": { "type": "string", "description": "Human-readable error message" },
        "code": { "type": "string", "description": "Unique error code for debugging" }
      }
    }
  },
  "errorCodes": {
    "REVIT_AUTH_001": "Access token required",
    "REVIT_AUTH_002": "Invalid or expired Azure Entra ID token",
    "REVIT_AUTH_003": "Token missing required claims",
    "REVIT_REG_002": "Plugin instance ID header required",
    "REVIT_REG_003": "Plugin not registered",
    "REVIT_REG_004": "Plugin registration deactivated",
    "REVIT_SESSION_001": "Session token required",
    "REVIT_SESSION_002": "Active session not found",
    "REVIT_PROJ_404": "Project not found",
    "REVIT_MAP_403": "Not authorized to modify mapping",
    "REVIT_MAP_404": "Material mapping not found",
    "REVIT_RATE_429": "Rate limit exceeded (100 requests/minute per session)",
    "REVIT_CATALOG_404": "Material not found in catalog",
    "REVIT_CATALOG_500": "Catalog search or retrieval failed",
    "REVIT_ALT_403": "Not authorized to access material alternatives",
    "REVIT_ALT_404": "Material mapping not found for alternatives",
    "REVIT_ALT_500": "Failed to get material alternatives",
    "REVIT_BATCH_400": "Invalid batch match request (missing materials array or exceeds limit)",
    "REVIT_BATCH_500": "Batch matching failed"
  },
  "rateLimits": {
    "default": {
      "requests": 100,
      "window": "1 minute"
    },
    "sync": {
      "requests": 10,
      "window": "1 minute",
      "note": "Material sync operations"
    }
  },
  "changelog": [
    {
      "version": "1.1.0",
      "date": "2026-01-04",
      "changes": [
        "Added GET /catalog/search - Optimized catalog search for Revit plugin",
        "Added GET /catalog/{materialId} - Get material details (lightweight)",
        "Added POST /materials/{mappingId}/alternatives - AI-powered sustainable alternatives",
        "Added POST /materials/batch-match - Batch material matching with confidence scores",
        "Added rate limiting (100 req/min per session) across all endpoints",
        "Added stricter rate limiting for sync operations (10 req/min)",
        "New definitions: Alternative, BatchMatchResult, CatalogMaterial, CatalogMaterialDetail"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2026-01-04",
      "changes": [
        "Initial release",
        "Azure Entra ID authentication",
        "Plugin registration and session management",
        "Project sync with sustainability scoring",
        "Material extraction and mapping",
        "Product search and auto-matching",
        "RFQ generation from mapped materials"
      ]
    }
  ]
}
