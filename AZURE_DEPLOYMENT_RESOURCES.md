# Azure Deployment Resources - Architecture Documentation

**Last Updated:** 2026-02-05  
**Status:** ğŸ”´ CRITICAL - Deployment Workflow Misalignment Identified

---

## ğŸ¯ Executive Summary

This document clarifies which Azure resources are deployed by which GitHub Actions workflows. A critical issue was identified: the `main_greenchainz-scraper.yml` workflow attempts to deploy to an Azure **Function App**, but the actual architecture uses Azure **Container Apps** exclusively.

---

## ğŸ“Š Current Azure Architecture

### Production Resources (Verified)

| Resource Type | Resource Name | Purpose | Deployment Workflow |
|---------------|---------------|---------|---------------------|
| **Container App** | `greenchainz-frontend` | Next.js 15 frontend application | `deploy-azure-cd.yml` |
| **Container App** | `greenchainz-container` | Node.js 20 backend API | `deploy-azure-cd.yml`, AutoDeploy triggers |
| **Container Registry** | `acrgreenchainzprod916` | Docker image storage | All Container App workflows |
| **PostgreSQL** | `greenchainz-db-prod` | Azure Database for PostgreSQL | Manual/IaC |
| **Blob Storage** | `greenchainzscraper`, `revitfiles` | File storage | Manual/IaC |
| **Key Vault** | `GreenChainz-vault-2026` | Secrets management | Manual/IaC |
| **App Registration** | Azure AD B2C | Authentication | Manual |

### âš ï¸ Deprecated/Uncertain Resources

| Resource Type | Resource Name | Status | Issue |
|---------------|---------------|--------|-------|
| **Function App** | `greenchainz-scraper` | â“ Uncertain | Referenced in workflow but may not exist or be deprecated |

---

## ğŸ”€ GitHub Actions Workflows Overview

### âœ… Active Production Workflows

#### 1. **`deploy-azure-cd.yml`** (Primary Production Deployment)
- **Purpose:** Build and deploy both frontend and backend Container Apps
- **Trigger:** Push to `main` branch or manual dispatch
- **Authentication:** Federated Identity (Zero Secrets)
- **Deployment Targets:**
  - `greenchainz-frontend` (Next.js frontend)
  - `greenchainz-container` (Node.js backend)
- **Secrets Used:**
  - `AZURE_CLIENT_ID` (Variable)
  - `AZURE_TENANT_ID` (Variable)
  - `AZURE_SUBSCRIPTION_ID` (Variable)
  - `NEXT_PUBLIC_INTERCOM_APP_ID` (Secret)
  - `CONTAINER_REGISTRY` (Variable)
  - `RESOURCE_GROUP` (Variable)
- **Node.js Version:** Not explicitly set (inherits from Dockerfile/Oryx)
- **Docker Images:**
  - Frontend: Uses root `Dockerfile`
  - Backend: Uses `backend/Dockerfile.azure`
- **Status:** âœ… **CORRECT - Aligns with Container App architecture**

#### 2. **`greenchainz-container-AutoDeployTrigger-118c312d-46c0-4285-af09-a03d38f9d660.yml`**
- **Purpose:** Auto-deployment for backend Container App (auto-generated by Azure)
- **Trigger:** Push to `main` branch or manual dispatch
- **Authentication:** OIDC with secrets
- **Deployment Target:** `greenchainz-container` only
- **Secrets Used:**
  - `GREENCHAINZCONTAINER_AZURE_CLIENT_ID`
  - `GREENCHAINZCONTAINER_AZURE_TENANT_ID`
  - `GREENCHAINZCONTAINER_AZURE_SUBSCRIPTION_ID`
  - `GREENCHAINZCONTAINER_REGISTRY_USERNAME`
  - `GREENCHAINZCONTAINER_REGISTRY_PASSWORD`
- **Resource Group:** `rg-greenchainz-prod-container` (production)
- **Action:** `azure/container-apps-deploy-action@v2`
- **Status:** âœ… **CORRECT - Container App deployment**
- **Note:** Consolidated workflow (duplicate non-production workflow removed)

---

### âœ… **RESOLVED: `main_greenchainz-scraper.yml` (Removed)**

#### Resolution

**Previous Issues (Now Resolved):**
- âŒ Wrong Azure Service Type: Used Function App action instead of Container Apps
- âŒ Resource doesn't exist: `greenchainz-scraper` Function App was never deployed
- âŒ No Function App code: Repository lacks Azure Functions structure
- âŒ Orphaned workflow: From previous architectural planning

**Action Taken:**
- ğŸ—‘ï¸ **WORKFLOW REMOVED** - File deleted from repository
- âœ… **Issue Resolved** - No longer a source of confusion
- âœ… **Documentation Updated** - References removed from active workflows

---

## ğŸ” Root Cause Analysis

### Historical Context

Based on archived documentation (`docs/archive/SCRAPER_DEPLOYMENT_STATUS.md`):

- **Original Plan:** Azure Function App `greenchainz-scraper` for web scraping operations
- **Intended Location:** `backend/functions/scrape-suppliers/`, `backend/functions/scrape-epd/`
- **Current Reality:** `backend/functions/` directory does **NOT EXIST** in repository
- **Migration:** Functionality likely moved to Container App backend or not implemented

### Current State

**Directory Structure Check:**
```bash
$ ls -la backend/functions
ls: cannot access 'backend/functions': No such file or directory
```

**Conclusion:** 
- Azure Functions implementation was planned but **never completed** or was **removed**
- The `main_greenchainz-scraper.yml` workflow is **orphaned** and non-functional
- No Function App code exists to deploy

---

## âœ… Completed Actions

### âœ… Priority 1: Deprecate or Remove Incorrect Workflow

**Action Taken:** Workflow completely removed from repository
- âœ… File deleted: `.github/workflows/main_greenchainz-scraper.yml`
- âœ… Documentation updated to reflect removal
- âœ… No Function App deployment confusion possible

### âœ… Priority 2: Consolidate Duplicate AutoDeploy Workflows

**Action Taken:** Workflows consolidated to single production workflow
- âœ… Kept: `greenchainz-container-AutoDeployTrigger-118c312d-*` (production)
- âœ… Removed: `greenchainz-container-AutoDeployTrigger-101801cc-*` (non-production)
- âœ… Single AutoDeploy workflow for `greenchainz-container`
- âœ… Primary workflow `deploy-azure-cd.yml` remains recommended method

### âœ… Priority 3: Update Documentation

**Completed Updates:**
- âœ… `AZURE_DEPLOYMENT_RESOURCES.md` - Workflows consolidated, Function App references removed
- âœ… `AZURE_DEPLOYMENT_CLARIFICATION_SUMMARY.md` - Updated to reflect completed actions
- ğŸ“‹ `.github/copilot-instructions.md` - Function App references to be reviewed

---

## ğŸ“‹ Remaining Actions (Require External Access)

### Priority 4: Audit GitHub Secrets (Requires Repository Admin Access)

**Recommended Action:**
Remove unused Function App secrets from GitHub repository settings:
- `AZUREAPPSERVICE_CLIENTID_1FFCC2E636CB46C2AE2804DCC984C403`
- `AZUREAPPSERVICE_TENANTID_FFA2562F65A344B3B8ABCE2B0E8E2D36`
- `AZUREAPPSERVICE_SUBSCRIPTIONID_AB79C7B6EBF84254ADD1EC34639A4E92`

**Steps:**
1. Go to: Repository Settings â†’ Secrets and variables â†’ Actions
2. Verify these secrets are not referenced in any workflows
3. Delete unused secrets

### Priority 5: Verify Azure Resources (Requires Azure Portal Access)

**Recommended Action:**
Confirm no orphaned Function App exists in Azure

**Verification Command:**
```bash
az functionapp show --name greenchainz-scraper --resource-group greenchainzscraper
```

**Expected Result:** Resource not found (confirming no orphaned resources)
- âš ï¸ `docs/archive/SCRAPER_DEPLOYMENT_STATUS.md` - Mark as outdated/archived

---

## ğŸ“‹ Deployment Workflow Decision Matrix

### When to Use Each Workflow

| Workflow | Use When | Don't Use When |
|----------|----------|----------------|
| `deploy-azure-cd.yml` | **Production deployments** to both frontend and backend Container Apps (RECOMMENDED) | Testing individual services |
| `AutoDeployTrigger-118c312d-*` | Auto-deployments managed by Azure (backend only) | Manual control needed or deploying frontend |
| ~~`main_greenchainz-scraper.yml`~~ | âŒ **REMOVED** - Never use | âŒ Always - removed from repository |
| ~~`AutoDeployTrigger-101801cc-*`~~ | âŒ **REMOVED** - Never use | âŒ Always - removed from repository |

---

## ğŸ”’ Secret Management

### Container App Secrets (Current - Correct)

#### Federated Identity Pattern (Preferred)
- `AZURE_CLIENT_ID` (Variable)
- `AZURE_TENANT_ID` (Variable)
- `AZURE_SUBSCRIPTION_ID` (Variable)
- Used in: `deploy-azure-cd.yml`

#### Legacy Pattern (Still Used)
- `GREENCHAINZCONTAINER_AZURE_CLIENT_ID`
- `GREENCHAINZCONTAINER_AZURE_TENANT_ID`
- `GREENCHAINZCONTAINER_AZURE_SUBSCRIPTION_ID`
- `GREENCHAINZCONTAINER_REGISTRY_USERNAME`
- `GREENCHAINZCONTAINER_REGISTRY_PASSWORD`
- Used in: AutoDeploy workflows

### Function App Secrets (Orphaned - Should Remove)

âŒ These secrets are likely unused and should be audited:
- `AZUREAPPSERVICE_CLIENTID_1FFCC2E636CB46C2AE2804DCC984C403`
- `AZUREAPPSERVICE_TENANTID_FFA2562F65A344B3B8ABCE2B0E8E2D36`
- `AZUREAPPSERVICE_SUBSCRIPTIONID_AB79C7B6EBF84254ADD1EC34639A4E92`

**Action:** Verify these secrets are not in use, then delete from GitHub repository settings.

---

## ğŸš€ Node.js Version Compliance

### âœ… All Workflows Validated

| Workflow | Node Version | Compliance | Notes |
|----------|--------------|------------|-------|
| `deploy-azure-cd.yml` | Inherits from Dockerfile | âœ… 20.x | Uses Dockerfile node:20-alpine |
| `AutoDeployTrigger-*.yml` | Inherits from Dockerfile | âœ… 20.x | Uses Dockerfile node:20-alpine |
| `main_greenchainz-scraper.yml` | 20.x (explicit) | âœ… 20.x | **But workflow is deprecated** |

### Central Configuration Sources

| Configuration | Value | Location |
|---------------|-------|----------|
| **Oryx Build** | 20.18.0 | `.oryx-node-version` |
| **Package Engines** | >=20.0.0 | `package.json` |
| **Dockerfiles** | node:20-alpine | `Dockerfile`, `Dockerfile.azure` |
| **Workflows** | 20.x | `main_greenchainz-scraper.yml` |

**Result:** âœ… All configurations align with Azure SDK requirements (Node.js >=20.0.0)

---

## ğŸ¯ Implementation Checklist

### Immediate Actions Required

- [ ] **Remove or disable `main_greenchainz-scraper.yml`**
  - [ ] Verify no Function App resource exists in Azure
  - [ ] Remove workflow file or rename to `.disabled`
  - [ ] Update documentation to remove Function App references

- [ ] **Audit and remove unused secrets**
  - [ ] Verify `AZUREAPPSERVICE_*` secrets are unused
  - [ ] Remove from GitHub repository settings
  - [ ] Document secret removal in changelog

- [ ] **Consolidate AutoDeploy workflows**
  - [ ] Determine production resource group
  - [ ] Keep one AutoDeploy workflow
  - [ ] Delete duplicate workflow
  - [ ] Test remaining workflow

- [ ] **Update documentation**
  - [ ] Update `.github/copilot-instructions.md`
  - [ ] Mark archived docs as outdated
  - [ ] Update deployment guides

### Validation Steps

- [ ] Run `scripts/validate-node-version.sh` to confirm Node.js compliance
- [ ] Review all GitHub Actions secrets in repository settings
- [ ] Test `deploy-azure-cd.yml` workflow (manual trigger)
- [ ] Verify Container Apps are accessible and functioning

---

## ğŸ“ Support and Troubleshooting

### Common Issues

**Issue 1: Workflow fails with Function App error**
- **Cause:** Using `Azure/functions-action@v1` for Container App
- **Fix:** Use `azure/container-apps-deploy-action@v2` instead

**Issue 2: Authentication fails with AZUREAPPSERVICE_* secrets**
- **Cause:** Wrong secret naming pattern for Container Apps
- **Fix:** Use `GREENCHAINZCONTAINER_*` or federated identity

**Issue 3: Build fails with Node.js version error**
- **Cause:** Mismatch between Oryx, package.json, and Dockerfile
- **Fix:** Run `scripts/validate-node-version.sh` and align versions

### Azure Resources Verification Commands

```bash
# List all Container Apps
az containerapp list --resource-group rg-greenchainz --output table
az containerapp list --resource-group rg-greenchainz-prod-container --output table

# Check if Function App exists (should return empty or not found)
az functionapp show --name greenchainz-scraper --resource-group greenchainzscraper 2>/dev/null

# List all secrets in Key Vault
az keyvault secret list --vault-name GreenChainz-vault-2026 --output table

# Check Container Registry images
az acr repository list --name acrgreenchainzprod916 --output table
```

---

## ğŸ“Š Summary

### Current State: âœ… Container Apps, âŒ Function Apps

**Production Architecture:**
- âœ… Frontend: `greenchainz-frontend` (Container App)
- âœ… Backend: `greenchainz-container` (Container App)
- âŒ Scraper: Not implemented (no Function App)

**Workflow Status:**
- âœ… `deploy-azure-cd.yml` - **Active, Correct**
- âš ï¸ `AutoDeployTrigger-*.yml` - **Active, Duplicate (needs consolidation)**
- âŒ `main_greenchainz-scraper.yml` - **Incorrect, Needs Removal**

**Node.js Compliance:**
- âœ… All configurations use Node.js 20.x
- âœ… Meets Azure SDK requirements (>=20.0.0)
- âœ… Consistent across Oryx, Dockerfiles, and workflows

---

## ğŸ Next Steps

1. **Immediate:** Remove or disable `main_greenchainz-scraper.yml` workflow
2. **Short-term:** Consolidate AutoDeploy workflows to remove duplication
3. **Medium-term:** Audit and clean up unused GitHub secrets
4. **Long-term:** Consider implementing scraper as Container App if functionality is needed

---

**Status:** ğŸ”´ **ACTION REQUIRED** - Incorrect workflow must be fixed  
**Priority:** ğŸ”¥ **HIGH** - Deployment clarity is critical for production stability  
**Owner:** DevOps / Infrastructure Team

**Last Reviewed:** 2026-02-05  
**Next Review:** After workflow corrections are implemented
