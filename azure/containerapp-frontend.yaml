# Azure Container Apps - Frontend Configuration
# Deploy with: az containerapp create --resource-group rg-greenchainz-prod-container --yaml azure/containerapp-frontend.yaml

properties:
  managedEnvironmentId: /subscriptions/f9164e8d-d74d-43ea-98d4-b0466b3ef8b8/resourceGroups/rg-greenchainz-prod-container/providers/Microsoft.App/managedEnvironments/cae-greenchainz-env
  
  configuration:
    activeRevisionsMode: Single
    secrets:
      - name: next-public-intercom-app-id
        # Use Key Vault secret name in lowercase with dashes
        # Ensure the system-assigned identity has 'Key Vault Secrets User' on this vault
        keyVaultUri: https://Greenchainz-vault-2026.vault.azure.net/secrets/next-public-intercom-app-id
      # Backend + auth secrets needed by Next.js API routes
      - name: database-url
        keyVaultUri: https://Greenchainz-vault-2026.vault.azure.net/secrets/Database-URL
      - name: azure-client-id
        keyVaultUri: https://Greenchainz-vault-2026.vault.azure.net/secrets/AzureAD-ClientId
      - name: azure-client-secret
        keyVaultUri: https://Greenchainz-vault-2026.vault.azure.net/secrets/AzureAD-ClientSecret
      - name: azure-tenant-id
        keyVaultUri: https://Greenchainz-vault-2026.vault.azure.net/secrets/AzureAD-TenantId
    ingress:
      external: true
      targetPort: 3000
      transport: http
      allowInsecure: false
      traffic:
        - latestRevision: true
          weight: 100
    
    registries:
      - server: acrgreenchainzprod916.azurecr.io
        identity: system

  template:
    containers:
      - name: greenchainz-frontend
        image: acrgreenchainzprod916.azurecr.io/greenchainz-frontend:latest
        resources:
          cpu: 0.25
          memory: 0.5Gi

        env:
          - name: NODE_ENV
            value: production
          - name: PORT
            value: "3000"
          # Server-side secrets for Next.js API routes (Azure auth + database)
          - name: DATABASE_URL
            secretRef: database-url
          - name: AZURE_CLIENT_ID
            secretRef: azure-client-id
          - name: AZURE_CLIENT_SECRET
            secretRef: azure-client-secret
          - name: AZURE_TENANT_ID
            secretRef: azure-tenant-id
          # Public runtime config (also baked in at build time via Docker build args)
          - name: NEXT_PUBLIC_BACKEND_URL
            value: https://greenchainz-container.jollyrock-a66f2da6.eastus.azurecontainerapps.io
          - name: NEXT_PUBLIC_AZURE_TENANT
            value: greenchainz2025.onmicrosoft.com
          - name: NEXT_PUBLIC_AZURE_CLIENT_ID
            value: "479e2a01-70ab-4df9-baa4-560d317c3423"
          - name: NEXT_PUBLIC_INTERCOM_APP_ID
            secretRef: next-public-intercom-app-id
        
        # ─────────────────────────────────────────────────────────────
        # Health Probes (use root path for Next.js)
        # ─────────────────────────────────────────────────────────────
        probes:
          - type: startup
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 30
          
          - type: liveness
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 30
            failureThreshold: 3
          
          - type: readiness
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3

    scale:
      minReplicas: 1
      maxReplicas: 5
      rules:
        - name: http-scale
          http:
            metadata:
              concurrentRequests: "100"

  identity:
    type: SystemAssigned
