# GreenChainz Azure Deployment Guide

Complete guide for deploying GreenChainz to Azure Container Apps.

## Required Secrets

### GitHub Secrets (for CI/CD)

Configure these in your repository under **Settings → Secrets and variables → Actions**:

| Secret Name | Description | How to Obtain |
|-------------|-------------|---------------|
| `AZURE_CREDENTIALS` | Azure Service Principal JSON | `az ad sp create-for-rbac --name "greenchainz-deploy" --role contributor --scopes /subscriptions/{subscription-id} --sdk-auth` |
| `ACR_USERNAME` | Azure Container Registry username | Azure Portal → Container Registry → Access keys |
| `ACR_PASSWORD` | Azure Container Registry password | Azure Portal → Container Registry → Access keys |
| `NEXT_PUBLIC_AZURE_TENANT` | Azure AD tenant name | e.g., `greenchainz2025.onmicrosoft.com` |
| `NEXT_PUBLIC_AZURE_CLIENT_ID` | Azure AD app client ID | Azure Portal → App registrations → Your app → Application (client) ID |

### Key Vault Secrets (for runtime)

Configure these in **greenchianz-vault** Key Vault:

| Secret Name | Description | How to Set |
|-------------|-------------|------------|
| `postgres-password` | PostgreSQL database password | `az keyvault secret set --vault-name greenchianz-vault --name postgres-password --value "YOUR_PASSWORD"` |
| `jwt-secret` | JWT signing secret | Auto-generated by `./azure/setup-secrets.sh` |
| `session-secret` | Express session secret | Auto-generated by `./azure/setup-secrets.sh` |
| `redis-password` | Azure Redis Cache password | Auto-fetched by `./azure/setup-secrets.sh` |

## Azure Resources

| Resource | Type | Location | Resource Group |
|----------|------|----------|----------------|
| acrgreenchainzprod916 | Container Registry | East US | rg-greenchainz-prod-container |
| cae-greenchainz-env | Container Apps Environment | East US | rg-greenchainz-prod-container |
| greenchainz-container | Container App (Backend) | East US | rg-greenchainz-prod-container |
| greenchainz-frontend | Container App (Frontend) | East US | rg-greenchainz-prod-container |
| greenchainz | Redis Cache | East US 2 | greenchainz-production |
| greenchianz-vault | Key Vault | East US | greenchainz-production |
| revitfiles | Storage Account | East US | rg-greenchainz |

## Quick Start

### 1. Prerequisites

```bash
# Install Azure CLI
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# Login to Azure
az login

# Set your subscription
az account set --subscription "greenchainz-core-start"
```

### 2. Configure Key Vault Secrets

```bash
# Set database password
export DB_PASSWORD="YOUR_DB_PASSWORD"

# Run the setup script (auto-generates JWT/session secrets, fetches Redis password)
chmod +x azure/setup-secrets.sh
./azure/setup-secrets.sh

# Grant managed identity access
chmod +x azure/grant-keyvault-access.sh
./azure/grant-keyvault-access.sh
```

### 3. Configure GitHub Secrets

```bash
# Create Service Principal for GitHub Actions
az ad sp create-for-rbac \
  --name "greenchainz-deploy" \
  --role contributor \
  --scopes /subscriptions/$(az account show --query id -o tsv) \
  --sdk-auth

# Copy the JSON output to GitHub Secret: AZURE_CREDENTIALS

# Get ACR credentials
az acr credential show --name acrgreenchainzprod916

# Copy username and password to GitHub Secrets: ACR_USERNAME, ACR_PASSWORD
```

### 4. Deploy

```bash
# Manual local deploy
./azure/deploy.sh all

# Or push to main branch for automatic CI/CD deployment
git push origin main
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Azure Container Apps                              │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────────┐  │
│  │    greenchainz-frontend     │   │       greenchainz-container         │  │
│  │         (Next.js)           │──▶│       (Node.js + Express)           │  │
│  │    Port: 3000               │   │       Port: 3001                    │  │
│  └─────────────────────────────┘   └─────────────────────────────────────┘  │
│              │                                    │                          │
└──────────────┼────────────────────────────────────┼──────────────────────────┘
               │                                    │
               ▼                                    ▼
┌──────────────────────────┐     ┌─────────────────────────────────────────────┐
│   Custom Domain (opt)    │     │             Azure Services                  │
│   greenchainz.com        │     │  ┌─────────────┐  ┌─────────────────────┐  │
└──────────────────────────┘     │  │  Redis      │  │  Key Vault          │  │
                                 │  │  Cache      │  │  (secrets)          │  │
                                 │  └─────────────┘  └─────────────────────┘  │
                                 │  ┌─────────────┐  ┌─────────────────────┐  │
                                 │  │  Blob       │  │  PostgreSQL         │  │
                                 │  │  Storage    │  │  (your DB)          │  │
                                 │  └─────────────┘  └─────────────────────┘  │
                                 └─────────────────────────────────────────────┘
```

## CI/CD Pipeline

The `.github/workflows/azure-deploy.yml` workflow:

1. **Triggers on:**
   - Push to `main` branch (with path filters)
   - Manual workflow dispatch

2. **Detects changes:**
   - Backend changes: `backend/**`, `database-schemas/**`
   - Frontend changes: `app/**`, `lib/**`, `public/**`, `Dockerfile`

3. **Deploys:**
   - Builds Docker images with caching
   - Pushes to Azure Container Registry
   - Updates Container Apps with new images
   - Verifies health endpoints

## Deployment Commands

```bash
# Deploy everything
./azure/deploy.sh all

# Deploy backend only
./azure/deploy.sh backend

# Deploy frontend only
./azure/deploy.sh frontend

# Check status
./azure/deploy.sh status

# View logs
./azure/deploy.sh logs greenchainz-container
```

## Health Endpoints

| App | Endpoint | Purpose |
|-----|----------|---------|
| Backend | `/health` | Liveness, readiness, and startup probes |
| Frontend | `/` | Liveness, readiness, and startup probes |

## Scaling

Container Apps auto-scale based on:
- **HTTP Concurrent Requests**: Backend >50, Frontend >100
- **CPU Utilization**: >70%

```bash
# Manual scaling
az containerapp update \
  --name greenchainz-container \
  --resource-group rg-greenchainz-prod-container \
  --min-replicas 2 \
  --max-replicas 20
```

## Troubleshooting

### Container App Not Starting

```bash
# Check logs
az containerapp logs show \
  --name greenchainz-container \
  --resource-group rg-greenchainz-prod-container \
  --follow

# Check revision status
az containerapp revision list \
  --name greenchainz-container \
  --resource-group rg-greenchainz-prod-container \
  -o table
```

### Key Vault Access Denied

```bash
# Get Container App managed identity
PRINCIPAL_ID=$(az containerapp show \
  --name greenchainz-container \
  --resource-group rg-greenchainz-prod-container \
  --query "identity.principalId" -o tsv)

# Grant Key Vault access
az keyvault set-policy \
  --name greenchianz-vault \
  --object-id $PRINCIPAL_ID \
  --secret-permissions get list
```

### Redis Connection Issues

```bash
# Test Redis connectivity
az redis show --name greenchainz --resource-group greenchainz-production

# Get connection info
az redis list-keys --name greenchainz --resource-group greenchainz-production
```

## Cost Estimate

Monthly cost with basic configuration:
- Container Apps (2 apps): ~$30-50
- Redis Cache (Basic): ~$16
- Storage (10GB): ~$2
- Key Vault: ~$1

**Total**: ~$50-70/month for basic usage
