# =============================================================================
# GreenChainz Azure Container Apps Deploy Pipeline
# =============================================================================
# Deploys frontend (Next.js) and backend (Node.js) to Azure Container Apps.
# Supports staging and production environments with separate resources.
#
# Required GitHub Secrets:
#   - AZURE_CREDENTIALS       : Azure Service Principal JSON (az ad sp create-for-rbac output)
#   - ACR_USERNAME            : Azure Container Registry username
#   - ACR_PASSWORD            : Azure Container Registry password
#   - NEXT_PUBLIC_AZURE_TENANT      : Azure AD tenant (e.g., greenchainz2025.onmicrosoft.com)
#   - NEXT_PUBLIC_AZURE_CLIENT_ID   : Azure AD app client ID (for frontend auth)
#
# Required Key Vault Secrets (in greenchianz-vault):
#   - postgres-password         : Database password
#   - jwt-secret                : JWT signing secret
#   - session-secret            : Express session secret
#   - redis-password            : Azure Redis Cache password
#   - stripe-secret-key         : Stripe API secret key
#   - stripe-webhook-secret     : Stripe webhook signing secret
#   - linkedin-client-id        : LinkedIn OAuth client ID
#   - linkedin-client-secret    : LinkedIn OAuth client secret
#
# Webhook Endpoints:
#   - Production: https://greenchainz-container.eastus.azurecontainerapps.io/api/webhooks/stripe
#   - Staging: https://greenchainz-container-staging.eastus.azurecontainerapps.io/api/webhooks/stripe
# =============================================================================

name: Azure Container Apps Deploy

permissions:
  contents: read

on:
  push:
    branches: 
      - main        # Production deployments
      - staging     # Staging deployments
    paths:
      - 'backend/**'
      - 'app/**'
      - 'lib/**'
      - 'public/**'
      - 'emails/**'
      - 'Dockerfile'
      - 'next.config.js'
      - 'package.json'
      - 'database-schemas/**'
      - '.github/workflows/azure-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: acrgreenchainzprod916.azurecr.io

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Determine environment and set configuration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      resource_group: ${{ steps.env.outputs.resource_group }}
      backend_app: ${{ steps.env.outputs.backend_app }}
      frontend_app: ${{ steps.env.outputs.frontend_app }}
      container_env: ${{ steps.env.outputs.container_env }}
    steps:
      - name: Determine environment
        id: env
        run: |
          # Determine environment based on trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            ENV="staging"
          else
            ENV="staging"
          fi
          
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          
          # Set environment-specific resources
          if [ "$ENV" == "production" ]; then
            echo "resource_group=rg-greenchainz-prod-container" >> $GITHUB_OUTPUT
            echo "backend_app=greenchainz-container" >> $GITHUB_OUTPUT
            echo "frontend_app=greenchainz-frontend" >> $GITHUB_OUTPUT
            echo "container_env=cae-greenchainz-env" >> $GITHUB_OUTPUT
          else
            echo "resource_group=rg-greenchainz-staging-container" >> $GITHUB_OUTPUT
            echo "backend_app=greenchainz-container-staging" >> $GITHUB_OUTPUT
            echo "frontend_app=greenchainz-frontend-staging" >> $GITHUB_OUTPUT
            echo "container_env=cae-greenchainz-staging-env" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸŽ¯ Deploying to: ${ENV}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Preflight: check whether target apps already exist
  # (bootstraps first-time creation even if only backend changes triggered the run)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preflight:
    needs: [setup]
    runs-on: ubuntu-latest
    outputs:
      backend_exists: ${{ steps.check.outputs.backend_exists }}
      frontend_exists: ${{ steps.check.outputs.frontend_exists }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check target apps exist
        id: check
        shell: bash
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          BACKEND_APP="${{ needs.setup.outputs.backend_app }}"
          FRONTEND_APP="${{ needs.setup.outputs.frontend_app }}"

          if az containerapp show --name "$BACKEND_APP" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "backend_exists=true" >> $GITHUB_OUTPUT
          else
            echo "backend_exists=false" >> $GITHUB_OUTPUT
          fi

          if az containerapp show --name "$FRONTEND_APP" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "frontend_exists=true" >> $GITHUB_OUTPUT
          else
            echo "frontend_exists=false" >> $GITHUB_OUTPUT
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect which components changed (for push events)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'database-schemas/**'
            frontend:
              - 'app/**'
              - 'lib/**'
              - 'public/**'
              - 'emails/**'
              - 'Dockerfile'
              - 'next.config.js'
              - 'package.json'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build and deploy backend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    needs: [setup, changes, preflight]
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend')) ||
      (github.event_name == 'push' && (needs.changes.outputs.backend == 'true' || needs.preflight.outputs.backend_exists == 'false'))
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    outputs:
      backend_url: ${{ steps.verify.outputs.backend_url }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile.azure
          push: true
          tags: |
            ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-backend:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Backend to Container Apps
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          BACKEND_APP="${{ needs.setup.outputs.backend_app }}"
          CONTAINER_ENV="${{ needs.setup.outputs.container_env }}"
          ENV="${{ needs.setup.outputs.environment }}"
          
          echo "ðŸ“¦ Deploying backend to ${ENV} environment..."
          
          # Check if app exists
          if az containerapp show --name "$BACKEND_APP" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "ðŸ“¦ Updating existing backend app..."
            az containerapp update \
              --name "$BACKEND_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --image ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
          else
            echo "ðŸ†• Creating new backend app..."
            az containerapp create \
              --name "$BACKEND_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINER_ENV" \
              --image ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }} \
              --target-port 3001 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 10 \
              --cpu 0.5 \
              --memory 1Gi \
              --registry-server ${{ env.REGISTRY }} \
              --registry-identity system
          fi
          
          # Ensure Stripe webhook endpoint is accessible
          echo "ðŸ”— Verifying ingress configuration for webhook endpoints..."
          az containerapp ingress show \
            --name "$BACKEND_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{targetPort: targetPort, external: external, transport: transport}" -o table
      
      - name: Verify Backend Deployment
        id: verify
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          BACKEND_APP="${{ needs.setup.outputs.backend_app }}"
          ENV="${{ needs.setup.outputs.environment }}"
          
          echo "â³ Waiting for backend to stabilize..."
          sleep 20
          
          BACKEND_URL=$(az containerapp show \
            --name "$BACKEND_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ðŸ” Health check: https://${BACKEND_URL}/health"

          # Retry to account for cold starts, DNS propagation, and image pulls.
          # curl returns 000 when it can't connect/resolve.
          MAX_ATTEMPTS=30
          SLEEP_SECONDS=10
          HTTP_STATUS=""

          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 20 \
              --retry 2 --retry-all-errors --retry-delay 2 \
              "https://${BACKEND_URL}/health" || echo "000")

            echo "Attempt ${i}/${MAX_ATTEMPTS}: status=${HTTP_STATUS}"

            if [ "$HTTP_STATUS" == "200" ]; then
              break
            fi

            sleep $SLEEP_SECONDS
          done

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Backend health check failed after ${MAX_ATTEMPTS} attempts (last status: ${HTTP_STATUS})"
            exit 1
          fi

          echo "backend_url=https://${BACKEND_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ… Backend deployed successfully to https://${BACKEND_URL}"
          echo ""
          echo "ðŸ“Œ Webhook Endpoints:"
          echo "   Stripe: https://${BACKEND_URL}/api/webhooks/stripe"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build and deploy frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    needs: [setup, changes, preflight, deploy-backend]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend')) ||
        (github.event_name == 'push' && (needs.changes.outputs.frontend == 'true' || needs.preflight.outputs.frontend_exists == 'false'))
      )
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    outputs:
      frontend_url: ${{ steps.verify.outputs.frontend_url }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get Backend URL
        id: backend-url
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          BACKEND_APP="${{ needs.setup.outputs.backend_app }}"
          ENV="${{ needs.setup.outputs.environment }}"
          
          BACKEND_FQDN=$(az containerapp show \
            --name "$BACKEND_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$BACKEND_FQDN" ]; then
            if [ "$ENV" == "production" ]; then
              BACKEND_FQDN="greenchainz-container.eastus.azurecontainerapps.io"
            else
              BACKEND_FQDN="greenchainz-container-staging.eastus.azurecontainerapps.io"
            fi
          fi
          
          echo "url=https://${BACKEND_FQDN}" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ Backend URL: https://${BACKEND_FQDN}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }}
            NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }}
            NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          tags: |
            ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-frontend:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy Frontend to Container Apps
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          FRONTEND_APP="${{ needs.setup.outputs.frontend_app }}"
          CONTAINER_ENV="${{ needs.setup.outputs.container_env }}"
          ENV="${{ needs.setup.outputs.environment }}"
          
          NODE_ENV_VALUE="production"
          if [ "$ENV" == "staging" ]; then
            NODE_ENV_VALUE="staging"
          fi
          
          # Check if frontend app exists
          if az containerapp show --name "$FRONTEND_APP" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "ðŸ“¦ Updating existing frontend app..."
            az containerapp update \
              --name "$FRONTEND_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }} \
              --set-env-vars \
                NODE_ENV=$NODE_ENV_VALUE \
                PORT=3000 \
                NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }} \
                NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }} \
                NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          else
            echo "ðŸ†• Creating new frontend app..."
            az containerapp create \
              --name "$FRONTEND_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINER_ENV" \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }} \
              --target-port 3000 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 5 \
              --cpu 0.25 \
              --memory 0.5Gi \
              --registry-server ${{ env.REGISTRY }} \
              --registry-identity system \
              --env-vars \
                NODE_ENV=$NODE_ENV_VALUE \
                PORT=3000 \
                NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }} \
                NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }} \
                NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          fi
      
      - name: Verify Frontend Deployment
        id: verify
        run: |
          RESOURCE_GROUP="${{ needs.setup.outputs.resource_group }}"
          FRONTEND_APP="${{ needs.setup.outputs.frontend_app }}"
          
          echo "â³ Waiting for frontend to stabilize..."
          sleep 20
          
          FRONTEND_URL=$(az containerapp show \
            --name "$FRONTEND_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ðŸ” Health check: https://${FRONTEND_URL}/"

          # Retry to account for cold starts, DNS propagation, and image pulls.
          # curl returns 000 when it can't connect/resolve.
          MAX_ATTEMPTS=30
          SLEEP_SECONDS=10
          HTTP_STATUS=""

          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 20 \
              --retry 2 --retry-all-errors --retry-delay 2 \
              "https://${FRONTEND_URL}/" || echo "000")

            echo "Attempt ${i}/${MAX_ATTEMPTS}: status=${HTTP_STATUS}"

            if [ "$HTTP_STATUS" == "200" ]; then
              break
            fi

            sleep $SLEEP_SECONDS
          done

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Frontend health check failed after ${MAX_ATTEMPTS} attempts (last status: ${HTTP_STATUS})"
            exit 1
          fi

          echo "frontend_url=https://${FRONTEND_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ… Frontend deployed successfully to https://${FRONTEND_URL}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deployment summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    needs: [setup, deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          BACKEND_APP="${{ needs.setup.outputs.backend_app }}"
          FRONTEND_APP="${{ needs.setup.outputs.frontend_app }}"

          BACKEND_URL="${{ needs.deploy-backend.outputs.backend_url }}"
          FRONTEND_URL="${{ needs.deploy-frontend.outputs.frontend_url }}"

          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="(not deployed in this run)"
          fi
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL="(not deployed in this run)"
          fi
          
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${ENV}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${BACKEND_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${FRONTEND_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Webhook Endpoints" >> $GITHUB_STEP_SUMMARY
          if [[ "$BACKEND_URL" == https://* ]]; then
            echo "- Stripe: ${BACKEND_URL}/api/webhooks/stripe" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Stripe: (backend not deployed in this run)" >> $GITHUB_STEP_SUMMARY
          fi
