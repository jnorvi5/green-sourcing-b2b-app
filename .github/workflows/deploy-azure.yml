name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: acrgreenchainzprod916.azurecr.io
  CONTAINER_NAME: greenchainz-frontend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Run linter
        run: npm run lint 2>&1 | grep -E "(error|warning)" || true

      - name: Azure login (Federated Identity)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.azure \
            -t ${{ env.REGISTRY }}/${{ env.CONTAINER_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ env.CONTAINER_NAME }}:latest \
            .

      - name: Push image to Azure Container Registry
        run: |
          az acr login --name acrgreenchainzprod916
          docker push ${{ env.REGISTRY }}/${{ env.CONTAINER_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.REGISTRY }}/${{ env.CONTAINER_NAME }}:latest

      - name: Deploy to Azure Container App
        run: |
          az containerapp update \
            --resource-group greenchainz-production \
            --name greenchainz-container \
            --image ${{ env.REGISTRY }}/${{ env.CONTAINER_NAME }}:${{ env.IMAGE_TAG }} \
            --set-env-vars \
            "AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            "AZURE_SQL_SERVER=${{ secrets.AZURE_SQL_SERVER }}" \
            "AZURE_SQL_USER=${{ secrets.AZURE_SQL_USER }}" \
            "AZURE_SQL_PASSWORD=${{ secrets['AZURE_SQL_PASSWORD'] }}" \
            "AZURE_SQL_DATABASE=${{ secrets.AZURE_SQL_DATABASE }}" \
            "AZURE_DOC_INTEL_ENDPOINT=${{ secrets.AZURE_DOC_INTEL_ENDPOINT }}" \
            "AZURE_DOC_INTEL_KEY=${{ secrets.AZURE_DOC_INTEL_KEY }}" \
            "AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
            "AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}" \
            "AZURE_OPENAI_DEPLOYMENT=${{ secrets.AZURE_OPENAI_DEPLOYMENT }}"

      - name: Verify deployment
        run: |
          echo "✅ Container App updated successfully"
          az containerapp show \
            --resource-group greenchainz-production \
            --name greenchainz-container \
            --query "properties.template.containers[0].image" -o tsv

      - name: Post deployment health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          CONTAINER_URL="https://greenchainz.com/api/health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $CONTAINER_URL || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "✅ Health check passed"
          else
            echo "⚠️ Health check returned $STATUS (may be initializing)"
          fi
