name: Build and Deploy to Azure

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'database-schemas/**'
      - '.github/workflows/azure-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

env:
  REGISTRY: acrgreenchainzprod916.azurecr.io
  RESOURCE_GROUP: rg-greenchainz-prod-container
  BACKEND_APP: greenchainz-container
  FRONTEND_APP: greenchainz-frontend
  CONTAINER_ENV: cae-greenchainz-env

jobs:
  # Detect which components changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'database-schemas/**'
            frontend:
              - 'frontend/**'

  # Build and deploy backend
  deploy-backend:
    needs: changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend') ||
      (github.event_name == 'push' && needs.changes.outputs.backend == 'true')
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile.azure
          push: true
          tags: |
            ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Backend to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
      
      - name: Verify Backend Deployment
        run: |
          # Wait for deployment to complete
          sleep 30
          
          # Get the app URL
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          # Health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${BACKEND_URL}/health)
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ Backend health check failed with status $HTTP_STATUS"
            exit 1
          fi
          
          echo "✅ Backend deployed successfully to https://${BACKEND_URL}"

  # Build and deploy frontend
  deploy-frontend:
    needs: [changes, deploy-backend]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend')) ||
        (github.event_name == 'push' && needs.changes.outputs.frontend == 'true')
      )
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || echo "greenchainz-container.eastus.azurecontainerapps.io")
          echo "url=https://${BACKEND_URL}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile.azure
          push: true
          build-args: |
            VITE_API_BASE_URL=${{ steps.backend-url.outputs.url }}
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          tags: |
            ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy Frontend to Container Apps
        run: |
          # Check if frontend app exists
          if az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            # Update existing app
            az containerapp update \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }}
          else
            # Create new app
            az containerapp create \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_ENV }} \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }} \
              --target-port 80 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 5 \
              --cpu 0.25 \
              --memory 0.5Gi \
              --registry-server ${{ env.REGISTRY }} \
              --registry-identity system
          fi
      
      - name: Verify Frontend Deployment
        run: |
          sleep 30
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${FRONTEND_URL}/)
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ Frontend health check failed with status $HTTP_STATUS"
            exit 1
          fi
          
          echo "✅ Frontend deployed successfully to https://${FRONTEND_URL}"

  # Post-deployment notification
  notify:
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
