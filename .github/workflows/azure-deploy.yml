# =============================================================================
# GreenChainz Azure Container Apps Deploy Pipeline
# =============================================================================
# Deploys frontend (Next.js) and backend (Node.js) to Azure Container Apps.
#
# Required GitHub Secrets:
#   - AZURE_CREDENTIALS       : Azure Service Principal JSON (az ad sp create-for-rbac output)
#   - ACR_USERNAME            : Azure Container Registry username
#   - ACR_PASSWORD            : Azure Container Registry password
#   - NEXT_PUBLIC_AZURE_TENANT      : Azure AD tenant (e.g., greenchainz2025.onmicrosoft.com)
#   - NEXT_PUBLIC_AZURE_CLIENT_ID   : Azure AD app client ID (for frontend auth)
#
# Required Key Vault Secrets (in greenchianz-vault):
#   - postgres-password       : Database password
#   - jwt-secret              : JWT signing secret
#   - session-secret          : Express session secret
#   - redis-password          : Azure Redis Cache password
# =============================================================================

name: Azure Container Apps Deploy

permissions:
  contents: read

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'app/**'
      - 'lib/**'
      - 'public/**'
      - 'emails/**'
      - 'Dockerfile'
      - 'next.config.js'
      - 'package.json'
      - 'database-schemas/**'
      - '.github/workflows/azure-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

env:
  REGISTRY: acrgreenchainzprod916.azurecr.io
  RESOURCE_GROUP: rg-greenchainz-prod-container
  BACKEND_APP: greenchainz-container
  FRONTEND_APP: greenchainz-frontend
  CONTAINER_ENV: cae-greenchainz-env

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect which components changed (for push events)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'database-schemas/**'
            frontend:
              - 'app/**'
              - 'lib/**'
              - 'public/**'
              - 'emails/**'
              - 'Dockerfile'
              - 'next.config.js'
              - 'package.json'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build and deploy backend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    needs: changes
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend')) ||
      (github.event_name == 'push' && needs.changes.outputs.backend == 'true')
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile.azure
          push: true
          tags: |
            ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Backend to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/greenchainz-backend:${{ github.sha }}
      
      - name: Verify Backend Deployment
        run: |
          echo "â³ Waiting for backend to stabilize..."
          sleep 30
          
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ðŸ” Health check: https://${BACKEND_URL}/health"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${BACKEND_URL}/health")
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Backend health check failed with status $HTTP_STATUS"
            exit 1
          fi
          
          echo "âœ… Backend deployed successfully to https://${BACKEND_URL}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build and deploy frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    needs: [changes, deploy-backend]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend')) ||
        (github.event_name == 'push' && needs.changes.outputs.frontend == 'true')
      )
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_FQDN=$(az containerapp show \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$BACKEND_FQDN" ]; then
            BACKEND_FQDN="greenchainz-container.eastus.azurecontainerapps.io"
          fi
          
          echo "url=https://${BACKEND_FQDN}" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ Backend URL: https://${BACKEND_FQDN}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }}
            NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }}
            NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          tags: |
            ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/greenchainz-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy Frontend to Container Apps
        run: |
          # Check if frontend app exists
          if az containerapp show --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "ðŸ“¦ Updating existing frontend app..."
            az containerapp update \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }} \
              --set-env-vars \
                NODE_ENV=production \
                PORT=3000 \
                NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }} \
                NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }} \
                NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          else
            echo "ðŸ†• Creating new frontend app..."
            az containerapp create \
              --name ${{ env.FRONTEND_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_ENV }} \
              --image ${{ env.REGISTRY }}/greenchainz-frontend:${{ github.sha }} \
              --target-port 3000 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 5 \
              --cpu 0.25 \
              --memory 0.5Gi \
              --registry-server ${{ env.REGISTRY }} \
              --registry-identity system \
              --env-vars \
                NODE_ENV=production \
                PORT=3000 \
                NEXT_PUBLIC_BACKEND_URL=${{ steps.backend-url.outputs.url }} \
                NEXT_PUBLIC_AZURE_TENANT=${{ secrets.NEXT_PUBLIC_AZURE_TENANT }} \
                NEXT_PUBLIC_AZURE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_AZURE_CLIENT_ID }}
          fi
      
      - name: Verify Frontend Deployment
        run: |
          echo "â³ Waiting for frontend to stabilize..."
          sleep 30
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ðŸ” Health check: https://${FRONTEND_URL}/"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${FRONTEND_URL}/")
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Frontend health check failed with status $HTTP_STATUS"
            exit 1
          fi
          
          echo "âœ… Frontend deployed successfully to https://${FRONTEND_URL}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deployment summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://greenchainz-container.eastus.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://greenchainz-frontend.eastus.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
